{% extends "layout.html" %} {% block title %}{{ board.name }} - Task Management
System{% endblock %} {% block content %}
<!-- Board Header -->
<div
    class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4"
>
    <div class="mb-3 mb-md-0">
        <h1>{{ board.name }}</h1>
        <p class="text-muted">
            {{ board.description or 'No description provided' }}
        </p>
    </div>
    <div class="board-header-buttons d-flex align-items-center flex-wrap gap-2">
        <div class="dropdown me-2">
            <button
                class="btn btn-primary dropdown-toggle"
                type="button"
                id="exportDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
            >
                <i class="bi bi-download"></i> Export
            </button>
            <ul
                class="dropdown-menu dropdown-menu-end"
                aria-labelledby="exportDropdown"
            >
                <li>
                    <a
                        class="dropdown-item"
                        href="{{ url_for('export_board_csv', board_id=board.id) }}"
                        >Export as CSV</a
                    >
                </li>
            </ul>
        </div>
        <button
            id="manage-users-button"
            class="btn btn-primary me-2"
            data-bs-toggle="modal"
            data-bs-target="#manageUsersModal"
        >
            <i class="bi bi-people"></i> Manage Members
        </button>
    </div>
</div>

<!-- Board Info -->
<div class="row mb-4">
    <div class="col-md-6 mt-2">
        <div class="card card-fancy">
            <div class="card-body">
                <h5 class="card-title">Board Information</h5>
                <p class="card-text">Created by: {{ board.creatorName }}</p>
                <p class="card-text">
                    Created at: {{ board.createdAt | format_datetime_exact }}
                </p>
                <p class="card-text">Members: {{ board.users|length }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6 mt-2">
        <div class="card card-fancy">
            <div class="card-body">
                <h5 class="card-title">Task Summary</h5>
                <p class="card-text">
                    Total tasks: <span id="task-count">{{ tasks|length }}</span>
                </p>
                <p class="card-text">
                    Completed tasks:
                    <span id="completed-task-count">
                        {{ tasks|selectattr('completed')|list|length }}
                    </span>
                </p>
                <p class="card-text">
                    Completion rate: {% if tasks %} {{
                    (tasks|selectattr('completed')|list|length / tasks|length *
                    100)|int }}% {% else %} 0% {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Task Management -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card card-fancy">
            <div class="card-body">
                <div
                    class="d-flex justify-content-between align-items-center mb-3"
                >
                    <h5 class="card-title mb-0">
                        Tasks (<span id="filtered-count" class="task-count"
                            >{{ tasks|length }}</span
                        >)
                    </h5>
                    <button
                        type="button"
                        class="btn btn-primary btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#addTaskModal"
                    >
                        <i class="bi bi-plus"></i> Add Task
                    </button>
                </div>

                <!-- Task Filters -->
                <div class="row g-2 align-items-center mb-3">
                    <!-- Task Search -->
                    <div class="col-12 col-md-auto">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input
                                type="text"
                                class="form-control"
                                id="task-search"
                                placeholder="Search tasks..."
                                aria-label="Search tasks"
                            />
                        </div>
                    </div>

                    <!-- Filter Buttons -->
                    <div class="col-12 col-md-auto">
                        <div class="btn-group w-100 w-md-auto" role="group">
                            <button
                                type="button"
                                class="btn btn-outline-secondary active filter-btn"
                                data-filter="all"
                            >
                                All
                            </button>
                            <button
                                type="button"
                                class="btn btn-outline-secondary filter-btn"
                                data-filter="active"
                            >
                                Active
                            </button>
                            <button
                                type="button"
                                class="btn btn-outline-secondary filter-btn"
                                data-filter="completed"
                            >
                                Completed
                            </button>
                        </div>
                    </div>

                    <!-- Due Date Filter -->
                    <div class="col-12 col-md-auto">
                        <input
                            type="date"
                            id="due-date-filter"
                            class="form-control"
                            placeholder="Due date or range"
                        />
                    </div>

                    <!-- Created Date Filter -->
                    <div class="col-12 col-md-auto">
                        <input
                            type="date"
                            id="created-date-filter"
                            class="form-control"
                            placeholder="Created date or range"
                        />
                    </div>

                    <!-- Assigned To Dropdown -->
                    <div class="col-12 col-md-auto">
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-secondary dropdown-toggle"
                                type="button"
                                id="assignedFilterDropdown"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                Assigned to
                            </button>
                            <ul
                                class="dropdown-menu"
                                aria-labelledby="assignedFilterDropdown"
                                id="assigned-filter-dropdown"
                            >
                                <li>
                                    <a
                                        class="dropdown-item assigned-filter"
                                        data-value="all"
                                        href="#"
                                        >All Users</a
                                    >
                                </li>
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item assigned-filter"
                                        data-value="{{ user.uid }}"
                                        href="#"
                                        >Me</a
                                    >
                                </li>
                                {% for board_user in board.users %} {% if
                                board_user.uid != user.uid %}
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item assigned-filter"
                                        data-value="{{ board_user.uid }}"
                                        href="#"
                                    >
                                        {{ board_user.displayName or
                                        board_user.email }}
                                    </a>
                                </li>
                                {% endif %} {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Created By Dropdown -->
                    <div class="col-12 col-md-auto">
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-secondary dropdown-toggle"
                                type="button"
                                id="createdByFilterDropdown"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                Created by
                            </button>
                            <ul
                                class="dropdown-menu"
                                aria-labelledby="createdByFilterDropdown"
                                id="created-by-filter-dropdown"
                            >
                                <li>
                                    <a
                                        class="dropdown-item created-by-filter"
                                        data-value="all"
                                        href="#"
                                        >All Users</a
                                    >
                                </li>
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item created-by-filter"
                                        data-value="{{ user.uid }}"
                                        href="#"
                                        >Assigned to me</a
                                    >
                                </li>
                                {% for board_user in board.users %} {% if
                                board_user.uid != user.uid %}
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item created-by-filter"
                                        data-value="{{ board_user.uid }}"
                                        href="#"
                                    >
                                        {{ board_user.displayName or
                                        board_user.email }}
                                    </a>
                                </li>
                                {% endif %} {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <!-- Sort Dropdown -->
                    <div class="col-12 col-md-auto">
                        <div class="dropdown">
                            <button
                                class="btn btn-outline-secondary dropdown-toggle"
                                type="button"
                                id="sortTasksDropdown"
                                data-bs-toggle="dropdown"
                                aria-expanded="false"
                            >
                                Newest First
                            </button>
                            <ul
                                class="dropdown-menu"
                                aria-labelledby="sortTasksDropdown"
                                id="sort-tasks-dropdown"
                            >
                                <li>
                                    <a
                                        class="dropdown-item sort-option"
                                        data-value="created-desc"
                                        href="#"
                                        >Newest First</a
                                    >
                                </li>
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item sort-option"
                                        data-value="created-asc"
                                        href="#"
                                        >Oldest First</a
                                    >
                                </li>
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item sort-option"
                                        data-value="due-asc"
                                        href="#"
                                        >Due Date (Earliest)</a
                                    >
                                </li>
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item sort-option"
                                        data-value="due-desc"
                                        href="#"
                                        >Due Date (Latest)</a
                                    >
                                </li>
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item sort-option"
                                        data-value="priority-desc"
                                        href="#"
                                        >Priority (High to Low)</a
                                    >
                                </li>
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item sort-option"
                                        data-value="priority-asc"
                                        href="#"
                                        >Priority (Low to High)</a
                                    >
                                </li>
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item sort-option"
                                        data-value="title-asc"
                                        href="#"
                                        >Title (A-Z)</a
                                    >
                                </li>
                                <div class="dropdown-divider"></div>
                                <li>
                                    <a
                                        class="dropdown-item sort-option"
                                        data-value="title-desc"
                                        href="#"
                                        >Title (Z-A)</a
                                    >
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-12 col-md-auto">
                        <button
                            id="clear-task-filters"
                            class="btn btn-secondary"
                        >
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Tasks List -->
                <div id="tasks-container">
                    {% if tasks %} {% for task in tasks %}
                    <div
                        class="task-item mt-3 mb-0 {{ 'completed' if task.completed }}"
                        data-id="{{ task.id }}"
                        data-completed="{{ 'true' if task.completed else 'false' }}"
                        data-created-by="{{ task.createdBy }}"
                        {%
                        if
                        task.assignedTo
                        %}
                        {%
                        if
                        task.assignedTo
                        is
                        sequence
                        and
                        task.assignedTo
                        is
                        not
                        mapping
                        %}
                        {%
                        for
                        user
                        in
                        task.assignedTo
                        %}
                        data-assigned-{{
                        user.uid
                        }}="true"
                        {%
                        endfor
                        %}
                        {%
                        else
                        %}
                        data-assigned-{{
                        task.assignedTo.uid
                        }}="true"
                        {%
                        endif
                        %}
                        {%
                        endif
                        %}
                    >
                        <div
                            class="d-flex justify-content-between align-items-start"
                        >
                            <div>
                                <h5 class="task-title">{{ task.title }}</h5>
                                <p class="text-muted mb-0">
                                    {{ task.description or 'No description' }}
                                </p>
                            </div>
                            <div class="task-actions">
                                {% if task.createdBy == user.uid or
                                board.createdBy == user.uid %}
                                <button
                                    class="btn btn-sm btn-outline-primary task-edit"
                                >
                                    <i class="bi bi-pencil"></i>
                                </button>
                                {% endif %}
                                <form
                                    action="{{ url_for('toggle_task', board_id=board.id, task_id=task.id) }}"
                                    method="post"
                                    class="d-inline"
                                >
                                    <button
                                        type="submit"
                                        class="btn btn-sm {{ 'btn-success' if task.completed else 'btn-outline-success' }} task-toggle"
                                    >
                                        <i
                                            class="bi {{ 'bi-check-circle-fill' if task.completed else 'bi-check-circle' }}"
                                        ></i>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <div class="task-meta">
                            <div>
                                <span
                                    class="me-2 {{ 'text-danger' if task.priority == 'high' else ('text-warning' if task.priority == 'medium' else 'text-success') }}"
                                >
                                    <i class="bi bi-flag-fill"></i> {{
                                    task.priority|capitalize }}
                                </span>
                                <span
                                    class="me-2 task-members-info"
                                    data-bs-toggle="tooltip"
                                    data-bs-html="true"
                                    title="{% if task.assignedTo %}
                                    {% if task.assignedTo is sequence and task.assignedTo is not mapping %}
                                    <strong>Assigned to:</strong><br>
                                    {% for user in task.assignedTo %}
                                    • {{ user.displayName or user.email }}<br>
                                    {% endfor %}
                                    {% else %}
                                    <strong>Assigned to:</strong><br>
                                    • {{ task.assignedTo.displayName or task.assignedTo.email }}
                                    {% endif %}
                                    {% else %}
                                    Not assigned to anyone
                                    {% endif %}"
                                >
                                    <i class="bi bi-people"></i>
                                    {% if task.assignedTo %} {% if
                                    task.assignedTo is sequence and
                                    task.assignedTo is not mapping %} {{
                                    task.assignedTo|length }} {% else %} 1 {%
                                    endif %} {% else %} Unassigned {% endif %}
                                </span>
                                <span class="me-2 badge bg-secondary"
                                    ><i class="bi bi-person-fill"></i> {{
                                    task.creatorName or 'Unknown' }}</span
                                >
                                <span class="me-2">
                                    <i class="bi bi-calendar"></i> {% if
                                    task.dueDate %} Due: {{ task.dueDate }} {%
                                    else %} No due date {% endif %}
                                </span>
                            </div>
                            <small
                                >Created at: {{ board.createdAt |
                                format_datetime_exact }}</small
                            >
                        </div>
                        <div class="task-comments mt-3">
                            <button
                                class="btn btn-sm btn-outline-secondary mb-0"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#commentsCollapse{{ task.id }}"
                            >
                                <i class="bi bi-chat-text"></i> Comments ({{
                                task.comments|length }})
                            </button>
                            <div
                                class="collapse"
                                id="commentsCollapse{{ task.id }}"
                            >
                                <!-- Comments list -->
                                <div class="list-group mt-2 mb-2">
                                    {% if task.comments %} {% for comment in
                                    task.comments %}
                                    <div
                                        class="list-group-item list-group-item-action"
                                    >
                                        <div
                                            class="d-flex w-100 justify-content-between"
                                        >
                                            <strong
                                                >{{ comment.creatorName
                                                }}</strong
                                            >
                                            <small
                                                >{{comment.createdAt |
                                                format_datetime_exact}}</small
                                            >
                                        </div>
                                        <p class="mb-1">{{ comment.text }}</p>
                                    </div>
                                    {% endfor %} {% else %}
                                    <div
                                        class="list-group-item text-center text-muted"
                                    >
                                        No comments yet
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Add comment form -->
                                <form
                                    action="{{ url_for('add_comment', board_id=board.id, task_id=task.id) }}"
                                    method="post"
                                >
                                    <div class="input-group">
                                        <input
                                            type="text"
                                            class="form-control form-control-sm"
                                            name="comment"
                                            placeholder="Add a comment..."
                                            required
                                        />
                                        <button
                                            class="btn btn-primary text-center"
                                            type="submit"
                                        >
                                            Post
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endfor %} {% else %}
                    <div class="text-center py-4 text-muted">
                        <i
                            class="bi bi-clipboard-x"
                            style="font-size: 2rem"
                        ></i>
                        <p>No tasks in this board yet</p>
                        <button
                            class="btn btn-sm btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#addTaskModal"
                        >
                            Add your first task
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div
                    id="no-tasks-message"
                    class="text-center text-muted py-4 d-none"
                >
                    <i class="bi bi-list-task" style="font-size: 2rem"></i>
                    <p>No tasks match the selected filters.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Board Users -->
<div class="card card-fancy mb-4">
    <div class="card-body">
        <h5 class="card-title">Board Members</h5>
        <div id="board-users-container">
            {% for user in board.users %}
            <div class="d-flex align-items-center mb-2">
                <div class="user-badge me-2">
                    <i class="bi bi-person-fill"></i>
                </div>
                <div class="flex-grow-1">
                    {{ user.displayName or user.email }} {% if user.role ==
                    'owner' %}
                    <span class="badge bg-dark ms-1">Owner</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<div>
    {% if is_owner %}
    <button
        id="delete-board-button"
        class="btn btn-danger"
        data-bs-toggle="modal"
        data-bs-target="#confirmDeleteBoardModal"
    >
        <i class="bi bi-trash"></i> Delete Board
    </button>
    {% endif %}
</div>

<!-- Modals -->
<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Task</h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <form
                action="{{ url_for('add_task', board_id=board.id) }}"
                method="post"
            >
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Task Title</label>
                        <input
                            type="text"
                            class="form-control"
                            id="title"
                            name="title"
                            required
                        />
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label"
                            >Description</label
                        >
                        <textarea
                            class="form-control"
                            id="description"
                            name="description"
                            rows="3"
                        ></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="due_date" class="form-label"
                            >Due Date (Optional)</label
                        >
                        <input
                            type="text"
                            class="form-control"
                            id="due_date"
                            name="due_date"
                            placeholder="Select a date"
                        />
                    </div>
                    <div class="mb-3">
                        <label for="assigned_to" class="form-label"
                            >Assign To</label
                        >
                        <select
                            class="form-select"
                            id="assigned_to"
                            name="assigned_to[]"
                            multiple
                        >
                            {% for board_user in board.users %}
                            <option value="{{ board_user.uid }}">
                                {{ board_user.displayName or board_user.email }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted"
                            >Hold Ctrl (or Cmd on Mac) to select multiple
                            users</small
                        >
                    </div>
                    <div class="mb-3">
                        <label for="priority" class="form-label"
                            >Priority</label
                        >
                        <select
                            class="form-select"
                            id="priority"
                            name="priority"
                        >
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Add Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Task Modal -->
<div class="modal fade" id="editTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Task</h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <form
                    id="edit-task-form"
                    action="{{ url_for('update_task', board_id=board.id, task_id='TASK_ID') }}"
                    method="post"
                >
                    <input type="hidden" id="edit-task-id" name="task_id" />
                    <div class="mb-3">
                        <label for="edit-title" class="form-label"
                            >Task Title</label
                        >
                        <input
                            type="text"
                            class="form-control"
                            id="edit-title"
                            name="title"
                            required
                        />
                    </div>
                    <div class="mb-3">
                        <label for="edit-description" class="form-label"
                            >Description</label
                        >
                        <textarea
                            class="form-control"
                            id="edit-description"
                            name="description"
                            rows="3"
                        ></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit-due-date" class="form-label"
                            >Due Date (Optional)</label
                        >
                        <input
                            type="date"
                            class="form-control"
                            id="edit-due-date"
                            name="due_date"
                        />
                    </div>
                    <div class="mb-3">
                        <label for="edit-assigned-to" class="form-label"
                            >Assign To</label
                        >
                        <select
                            class="form-select"
                            id="edit-assigned-to"
                            name="assigned_to[]"
                            multiple
                        >
                            {% for board_user in board.users %}
                            <option value="{{ board_user.uid }}">
                                {{ board_user.displayName or board_user.email }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted"
                            >Hold Ctrl (or Cmd on Mac) to select multiple
                            users</small
                        >
                    </div>
                    <div class="mb-3">
                        <label for="edit-priority" class="form-label"
                            >Priority</label
                        >
                        <select
                            class="form-select"
                            id="edit-priority"
                            name="priority"
                        >
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="mb-3 form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="edit-completed"
                            name="completed"
                        />
                        <label class="form-check-label" for="edit-completed"
                            >Mark as completed</label
                        >
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">
                            Update Task
                        </button>
                    </div>
                </form>
                <style>
                    .no-border-footer {
                        border-top: none !important;
                    }
                </style>
                <div class="modal-footer no-border-footer">
                    <!-- Form for task deletion -->
                    <form
                        id="delete-task-form"
                        action="{{ url_for('delete_task', board_id=board.id, task_id='TASK_ID') }}"
                        method="post"
                        class="d-inline me-auto"
                    >
                        <button
                            type="button"
                            class="btn btn-danger"
                            id="delete-task-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmDeleteTaskModal"
                        >
                            Delete Task
                        </button>
                    </form>
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                        id="cancel-edit-button"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Manage Users Modal -->
<div class="modal fade" id="manageUsersModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Manage Board Members</h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <ul id="current-users-list" class="list-group mb-3">
                    {% if not is_owner %}
                    <p style="color: coral; text-align: center">
                        Only owners have access to manage the board members.
                    </p>
                    {% endif %} {% for board_user in board.users %}
                    <li
                        class="list-group-item d-flex justify-content-between align-items-center"
                    >
                        <div>
                            {{ board_user.displayName or board_user.email }} {%
                            if board_user.role == 'owner' %}
                            <span class="badge bg-dark ms-1">Owner</span>
                            {% endif %}
                        </div>
                        {% if is_owner and board_user.role != 'owner' %}
                        <button
                            type="button"
                            class="btn btn-sm btn-outline-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmRemoveUserModal"
                            data-user-id="{{ board_user.uid }}"
                            data-user-name="{{ board_user.displayName or board_user.email }}"
                        >
                            <i class="bi bi-x-circle"></i>
                        </button>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>

                <!-- Add New User Form -->
                {% if is_owner %}
                <h6>Add New User</h6>
                <form
                    action="{{ url_for('add_user', board_id=board.id) }}"
                    method="post"
                >
                    <div class="input-group mb-3">
                        <input
                            type="email"
                            class="form-control"
                            id="email"
                            name="email"
                            placeholder="Enter email address"
                            required
                        />
                        <button class="btn btn-primary" type="submit">
                            Add User
                        </button>
                    </div>
                </form>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Delete Board Modal -->
<div class="modal fade" id="confirmDeleteBoardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <p>
                    Are you sure you want to delete this board? This action
                    cannot be undone.
                </p>
                <p class="text-danger">
                    <strong>Warning:</strong> All tasks and data associated with
                    this board will also be deleted.
                </p>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Cancel
                </button>
                <form
                    action="{{ url_for('delete_board', board_id=board.id) }}"
                    method="post"
                >
                    <button type="submit" class="btn btn-danger">
                        Delete Board
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Task Modal -->
<div class="modal fade" id="confirmDeleteTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="delete-task-form-modal" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Task Deletion</h5>
                    <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger">
                        Are you sure you want to delete this task? This action
                        cannot be undone.
                    </p>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        Yes, Delete
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Confirm Remove User Modal -->
<div class="modal fade" id="confirmRemoveUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="remove-user-form" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm User Removal</h5>
                    <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Close"
                    ></button>
                </div>
                <div class="modal-body">
                    <p style="color: crimson">
                        Are you sure you want to remove
                        <strong id="remove-user-name">this user</strong>
                        from the board?
                    </p>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger">
                        Remove User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %} {% block scripts %}
<script>
    let currentSort = 'created-desc';
    let currentCreatedByFilter = 'all';

    // Pass tasks data as JSON so JavaScript can access it and log it
    const tasksData = {{ tasks|tojson|safe }};

    document.getElementById('cancel-edit-button').addEventListener('click', function() {
        // Remove modal backdrop manually
        const modalBackdrops = document.querySelectorAll('.modal-backdrop');
        modalBackdrops.forEach(backdrop => {
            backdrop.parentNode.removeChild(backdrop);
        });
        document.body.classList.remove('modal-open');
        document.body.style.paddingRight = '';
    });

    // Task filtering
    const filterButtons = document.querySelectorAll('.filter-btn');
    const assignedFilter = document.getElementById('assigned-filter');
    const createdDateFilter = document.getElementById('created-date-filter');
    const taskItems = document.querySelectorAll('.task-item');
    let currentFilter = 'all';
    let currentAssignedFilter = 'all';

    // Apply filters
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            currentFilter = button.getAttribute('data-filter');
            applyFilters();
        });
    });

    if (assignedFilter) {
        assignedFilter.addEventListener('change', () => {
            currentAssignedFilter = assignedFilter.value;
            applyFilters();
        });
    }

    function applyFilters() {
        const currentUserId = "{{ user.uid }}";
        const selectedDate = createdDateFilter?.value || null;
        const searchTerm = document.getElementById('task-search')?.value.toLowerCase() || '';
        let visibleCount = 0;

        taskItems.forEach(task => {
            // Get task data attributes
            const completed = task.getAttribute('data-completed') === 'true';
            const createdBy = task.getAttribute('data-created-by');

            // Filter by status
            let statusMatch = true;
            if (currentFilter === 'active' && completed) {
                statusMatch = false;
            } else if (currentFilter === 'completed' && !completed) {
                statusMatch = false;
            }

            // Filter by assigned user
            let assignedMatch = true;
            if (currentAssignedFilter === 'me') {
                assignedMatch = task.hasAttribute(`data-assigned-${currentUserId}`);
            } else if (currentAssignedFilter !== 'all') {
                assignedMatch = task.hasAttribute(`data-assigned-${currentAssignedFilter}`);
            }

            // Filter by created by
            let createdByMatch = true;
            if (currentCreatedByFilter !== 'all') {
                createdByMatch = createdBy === currentCreatedByFilter;
            }

            // Filter by search term
            const title = task.querySelector('.task-title')?.textContent.toLowerCase() || '';
            const description = task.querySelector('.card-text, .text-muted')?.textContent.toLowerCase() || '';
            const searchMatch = title.includes(searchTerm) || description.includes(searchTerm);

            let createdDateMatch = true;
            const dateRangeValue = document.getElementById('created-date-filter')?.value;

            if (dateRangeValue) {
                const [start, end] = dateRangeValue.split(" to ");
                const taskId = task.getAttribute("data-id");
                const taskData = tasksData.find(t => t.id === taskId);

                if (taskData?.createdAt) {
                    const created = new Date(taskData.createdAt);
                    const createdDateStr = created.toISOString().split('T')[0];

                    if (start && end) {
                        createdDateMatch = createdDateStr >= start && createdDateStr <= end;
                    } else {
                        createdDateMatch = createdDateStr === start;
                    }
                } else {
                    createdDateMatch = false;
                }
            }

            // Filter by due date
            const dueDateRange = document.getElementById("due-date-filter")?.value || '';
            let dueDateMatch = true;

            if (dueDateRange) {
                const [start, end] = dueDateRange.split(" to ");
                const taskId = task.getAttribute('data-id');
                const taskData = tasksData.find(t => t.id === taskId);
                const dueDate = taskData?.dueDate;

                if (dueDate) {
                    if (start && end) {
                        // Check if dueDate is within range
                        dueDateMatch = (dueDate >= start && dueDate <= end);
                    } else {
                        // Single date selected
                        dueDateMatch = (dueDate === start);
                    }
                } else {
                    dueDateMatch = false; // No dueDate means no match
                }
            }

            const shouldShow = statusMatch && assignedMatch && searchMatch && createdDateMatch && dueDateMatch && createdByMatch;

            // Show or hide based on filters
            task.style.display = shouldShow ? 'block' : 'none';
            if (shouldShow) visibleCount++;
        });

        // Date specific filter case
        const noTasksMsg = document.getElementById("no-tasks-message");
        if (noTasksMsg) {
            noTasksMsg.classList.toggle("d-none", visibleCount > 0);
        }

        // Update task count display if it exists
        const tasksCountElement = document.querySelector('.tasks-count');
        if (tasksCountElement) {
            tasksCountElement.textContent = visibleCount;
        }
    }

    // Task sorting function
    function sortTasks() {
        const sortValue = currentSort;
        const tasksContainer = document.getElementById('tasks-container');
        const taskItems = Array.from(tasksContainer.querySelectorAll('.task-item'));

        // Sort the tasks
        taskItems.sort((a, b) => {
            switch (sortValue) {
                case 'created-desc':
                    return getTaskDate(b, 'createdAt') - getTaskDate(a, 'createdAt');
                case 'created-asc':
                    return getTaskDate(a, 'createdAt') - getTaskDate(b, 'createdAt');
                case 'due-asc':
                    return getTaskDate(a, 'dueDate') - getTaskDate(b, 'dueDate');
                case 'due-desc':
                    return getTaskDate(b, 'dueDate') - getTaskDate(a, 'dueDate');
                case 'priority-desc':
                    return getPriorityValue(b) - getPriorityValue(a);
                case 'priority-asc':
                    return getPriorityValue(a) - getPriorityValue(b);
                case 'title-asc':
                    return getTaskTitle(a).localeCompare(getTaskTitle(b));
                case 'title-desc':
                    return getTaskTitle(b).localeCompare(getTaskTitle(a));
                default:
                    return 0;
            }
        });

        // Re-append tasks in sorted order
        taskItems.forEach(task => {
            tasksContainer.appendChild(task);
        });
    }

    // Helper functions for sorting
    function getTaskDate(taskElement, attribute) {
        // Find the task in tasksData by ID
        const taskId = taskElement.getAttribute('data-id');
        const task = tasksData.find(t => t.id === taskId);

        if (!task) return 0;

        if (attribute === 'dueDate') {
            if (!task.dueDate) return Infinity; // No due date should be last
            return new Date(task.dueDate).getTime();
        } else {
            if (!task.createdAt) return 0;
            return new Date(task.createdAt).getTime();
        }
    }

    function getPriorityValue(taskElement) {
        const taskId = taskElement.getAttribute('data-id');
        const task = tasksData.find(t => t.id === taskId);

        if (!task) return 0;

        // Convert priority to numeric value
        switch (task.priority) {
            case 'high': return 3;
            case 'medium': return 2;
            case 'low': return 1;
            default: return 0;
            }
    }

    function getTaskTitle(taskElement) {
        const titleElement = taskElement.querySelector('.task-title');
        return titleElement ? titleElement.textContent.trim() : '';
    }

    function showEditTaskModal(taskId) {
        // Find the task by ID
        const task = tasksData.find(t => t.id === taskId);
        if (!task) {
        return;
    }

    // Set task ID in hidden field
    document.getElementById('edit-task-id').value = taskId;

    // Set form action URL
    const form = document.getElementById('edit-task-form');
    form.action = form.action.replace('TASK_ID', taskId);

    // Set delete form action URL
    const deleteForm = document.getElementById('delete-task-form');
    deleteForm.action = deleteForm.action.replace('TASK_ID', taskId);

    // Set values in the form
    document.getElementById('edit-title').value = task.title || '';
    document.getElementById('edit-description').value = task.description || '';
    document.getElementById('edit-due-date').value = task.dueDate || '';

    // Set priority
    const prioritySelect = document.getElementById('edit-priority');
    for (let i = 0; i < prioritySelect.options.length; i++) {
        prioritySelect.options[i].selected = (prioritySelect.options[i].value === task.priority);
    }

    // Set completed status
    document.getElementById('edit-completed').checked = task.completed || false;

    // Set assigned users
    const assignedToSelect = document.getElementById('edit-assigned-to');

    // First, clear all selections
    for (let i = 0; i < assignedToSelect.options.length; i++) {
        assignedToSelect.options[i].selected = false;
    }

    // Then set the correct ones
    if (task.assignedTo) {
        // Handle both single user and array of users
        const assignees = Array.isArray(task.assignedTo) ? task.assignedTo : [task.assignedTo];

        assignees.forEach(user => {
            if (user && user.uid) {
                for (let i = 0; i < assignedToSelect.options.length; i++) {
                    if (assignedToSelect.options[i].value === user.uid) {
                        assignedToSelect.options[i].selected = true;
                    }
                }
            }
        });
    }

    // Setup dynamic delete form for confirmation modal
    document.getElementById('delete-task-btn').onclick = function () {
        const deleteForm = document.getElementById('delete-task-form-modal');
        deleteForm.action = `/delete-task/{{ board.id }}/${taskId}`;
    };

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
    modal.show();
    }

    window.showEditTaskModal = showEditTaskModal;

    // Fix for modal backdrop issue
    document.getElementById('cancel-edit-button').addEventListener('click', function() {

        // Remove modal backdrop manually
    setTimeout(() => {
        const modalBackdrops = document.querySelectorAll('.modal-backdrop');
        modalBackdrops.forEach(backdrop => {
        backdrop.parentNode.removeChild(backdrop);
    });
    document.body.classList.remove('modal-open');
    document.body.style.paddingRight = '';
    }, 200);
    });

    document.addEventListener('DOMContentLoaded', function () {

        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                html: true,
                placement: 'top'
            });
        });

        // Mobile-friendly members view with modal
        const memberIcons = document.querySelectorAll('.task-members-info');
        memberIcons.forEach(icon => {
            icon.addEventListener('click', function(e) {
                e.preventDefault();

                // Get the tooltip content
                const tooltipContent = this.getAttribute('data-bs-original-title') || this.getAttribute('title');

                // Find the task title
                const taskItem = this.closest('.task-item');
                const taskTitle = taskItem ? taskItem.querySelector('.task-title').textContent.trim() : 'Task';

                // Get the modal elements
                const modal = document.getElementById('taskMembersModal');
                const modalTitle = modal.querySelector('.modal-title');
                const modalBody = document.getElementById('taskMembersModalBody');

                // Set content
                modalTitle.textContent = `Assigned Members: ${taskTitle}`;
                modalBody.innerHTML = tooltipContent;

                // Show the modal
                const taskModal = new bootstrap.Modal(modal);
                taskModal.show();
            });
        });

        const editButtons = document.querySelectorAll(".task-edit");
        editButtons.forEach((button) => {
            button.addEventListener("click", function () {
                const taskId = this.closest(".task-item").dataset.id;
                showEditTaskModal(taskId);
            });
        });

        const confirmModal = document.getElementById("confirmRemoveUserModal");
        const form = document.getElementById("remove-user-form");
        const nameHolder = document.getElementById("remove-user-name");

        confirmModal.addEventListener("show.bs.modal", function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute("data-user-id");
            const userName = button.getAttribute("data-user-name");

            nameHolder.textContent = userName;
            form.action = `/remove-user/{{ board.id }}/${userId}`;
        });

        const sortSelect = document.getElementById('sort-tasks');
        if (sortSelect) {
            sortSelect.addEventListener('change', sortTasks);
        }

        const searchInput = document.getElementById('task-search');
        if (searchInput) {
            searchInput.addEventListener('input', applyFilters);
        }

        applyFilters();

        const assignedDropdownBtn = document.getElementById('assignedFilterDropdown');
        const sortDropdownBtn = document.getElementById('sortTasksDropdown');

        // Assigned user filter
        document.querySelectorAll('.assigned-filter').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const value = this.getAttribute('data-value');
                assignedDropdownBtn.textContent = `${this.textContent}`;
                currentAssignedFilter = value;
                applyFilters();
            });
        });

        // Sort filter
        document.querySelectorAll('.sort-option').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const sortValue = this.getAttribute('data-value');

                currentSort = sortValue;
                document.getElementById('sortTasksDropdown').textContent = `${this.textContent}`;
                sortTasks();  // Call sorting after updating
            });
        });

        // Filter task by created date/range
        flatpickr("#created-date-filter", {
            mode: "range", dateFormat: "Y-m-d", allowInput: true,
            onChange: function () {
                applyFilters();
            }
        });
        const createdDateInput = document.getElementById("created-date-filter");
        if (createdDateInput) {
            createdDateInput.addEventListener("change", applyFilters);
        }

        // Filter task by due date/range
        flatpickr("#due-date-filter", {
            mode: "range", dateFormat: "Y-m-d", allowInput: true,
            onChange: function () {
                applyFilters();
            }
        });
        const dueDateFilterInput = document.getElementById('due-date-filter');
        if (dueDateFilterInput) {
            dueDateFilterInput.addEventListener('change', applyFilters);
        }

        // Created by filter
        const createdByDropdownBtn = document.getElementById('createdByFilterDropdown');
        document.querySelectorAll('.created-by-filter').forEach(item => {
            item.addEventListener('click', function (e) {
                e.preventDefault();
                const value = this.getAttribute('data-value');
                createdByDropdownBtn.textContent = `Created By: ${this.textContent.trim()}`;
                currentCreatedByFilter = value;
                applyFilters();
            });
        });

        // Clear all filters
        const clearTaskFiltersBtn = document.getElementById("clear-task-filters");
        if (clearTaskFiltersBtn) {
            clearTaskFiltersBtn.addEventListener("click", () => {
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
                currentFilter = 'all';

                currentAssignedFilter = 'all';
                document.getElementById('assignedFilterDropdown').textContent = 'All Users';

                currentSort = 'created-desc';
                document.getElementById('sortTasksDropdown').textContent = 'Newest First';

                currentCreatedByFilter = 'all';
                document.getElementById('createdByFilterDropdown').textContent = 'Created by';

                document.getElementById('task-search').value = '';
                document.getElementById('created-date-filter')?._flatpickr?.clear();
                document.getElementById('due-date-filter')?._flatpickr?.clear();

                applyFilters();
                sortTasks();
            });
        }
    });

    // Due date for task
    flatpickr("#due_date", {
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "F j, Y",
        allowInput: true
    });
</script>
{% endblock %}
